<!DOCTYPE html>
<html>

<head>
    <style>
        html,
        body {
            overflow: hidden;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #renderCanvas {
            width: 100%;
            height: 100%;
            touch-action: none;
        }
    </style>

    <meta http-equiv="Content-Type" content="text/html" charset="utf-8" />
    <title>Babylon - Getting Started</title>
    <!-- Link to the last version of BabylonJS -->
    <script src="https://preview.babylonjs.com/babylon.js"></script>
    <!-- Link to the last version of BabylonJS loaders to enable loading filetypes such as .gltf -->
    <script src="https://preview.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
    <!-- Link to pep.js to ensure pointer events work consistently in all browsers -->
    <script src="https://code.jquery.com/pep/0.4.1/pep.js"></script>

    <link href="https://unpkg.com/filepond/dist/filepond.css" rel="stylesheet">
</head>

<body>
    <input type="file">
    <canvas id="renderCanvas"></canvas>
    <script>

        function createScene(tubePathes) {
            var canvas = document.getElementById('renderCanvas');
            var engine = new BABYLON.Engine(canvas, true);
            var scene = new BABYLON.Scene(engine);

            var camera = new BABYLON.ArcRotateCamera("Camera", 3 * Math.PI / 2, 3 * Math.PI / 8, 30, BABYLON.Vector3.Zero(), scene);

            camera.attachControl(canvas, true);

            var light = new BABYLON.HemisphericLight("hemi", new BABYLON.Vector3(0, 50, 0), scene);
            for (var path of tubePathes) {
                BABYLON.MeshBuilder.CreateTube("tube", { path: path, radius: 0.05, sideOrientation: BABYLON.Mesh.DOUBLESIDE, updatable: true }, scene);
            }
            engine.runRenderLoop(function () {
                scene.render();
            });
            window.addEventListener('resize', function () {
                engine.resize();
            });
        }
        function createPathes(edges) {
            var pathes = []
            for (var edge of edges) {
                pathes.push(createPath(edge))
            }
            return pathes
        }
        function createPath(edge) {
            var vectors = []
            if (edge.length > 3) {
                var a = Math.floor(edge.length / 3)
                var b = Math.floor(edge.length / 3 * 2)
                var c = edge.length - 1
                vectors.push(new BABYLON.Vector3(edge[0][0], edge[0][1], edge[0][2]))
                vectors.push(new BABYLON.Vector3(edge[a][0], edge[a][1], edge[a][2]))
                vectors.push(new BABYLON.Vector3(edge[b][0], edge[b][1], edge[b][2]))
                vectors.push(new BABYLON.Vector3(edge[c][0], edge[c][1], edge[c][2]))
                return BABYLON.Curve3.CreateCubicBezier(vectors[0], vectors[1], vectors[2], vectors[3], edge.length).getPoints()
            }
            for (var p of edge) {
                vectors.push(new BABYLON.Vector3(p[0], p[1], p[2]))
            }
            return BABYLON.Curve3.CreateCatmullRomSpline(vectors, 1).getPoints()

        }
    </script>
    <script src="https://unpkg.com/filepond/dist/filepond.js"></script>

    <script>

        function parseGraph(text) {
            var lines = text.split('\n');
            var edges = []
            var edge = []
            for (var i = 0; i < lines.length; i++) {
                var words = lines[i].split(" ")
                if (words.length == 2) {
                    if (edge.length > 1) {
                        edges.push(edge)
                    }
                    edge = []
                }
                if (words.length == 4) {
                    edge.push([parseFloat(words[0]), parseFloat(words[1]), parseFloat(words[2]), parseFloat(words[3])])
                }
            }
            if (edge.length > 1) {
                edges.push(edge)
            }
            return edges
        }

        function onFileUpload(error, fileWrapper) {
            if (window.File && window.FileReader && window.FileList && window.Blob) {
                var reader = new FileReader();

                reader.onload = function () { processFile(reader.result) };
                reader.readAsText(fileWrapper.file);
            } else {
                alert('The File APIs are not fully supported in this browser.');
            }
        }

        function processFile(text) {
            createScene(createPathes(parseGraph(text)))
        }

        var inputElement = document.querySelector('input[type="file"]');
        var pond = FilePond.create(inputElement);

        pond.onaddfile = onFileUpload;
    </script>

</body>

</html>